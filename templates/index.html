import os
import requests
from flask import Flask, request, jsonify
from twilio.twiml.voice_response import VoiceResponse
from twilio.rest import Client

# Load environment variables directly from Koyeb
ELEVENLABS_API_KEY = os.getenv('ELEVENLABS_API_KEY')
ELEVENLABS_AGENT_ID = os.getenv('ELEVENLABS_AGENT_ID')
TWILIO_ACCOUNT_SID = os.getenv('TWILIO_ACCOUNT_SID')
TWILIO_AUTH_TOKEN = os.getenv('TWILIO_AUTH_TOKEN')
TWILIO_PHONE_NUMBER = os.getenv('TWILIO_PHONE_NUMBER')

# Initialize Flask app
app = Flask(__name__)

# Initialize Twilio client
twilio_client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)

# Function to generate audio from ElevenLabs TTS API
def generate_elevenlabs_audio(text):
    url = f"https://api.elevenlabs.io/v1/convai/voice/generate?agent_id={ELEVENLABS_AGENT_ID}"
    headers = {
        "xi-api-key": ELEVENLABS_API_KEY,
        "Content-Type": "application/json"
    }
    data = {
        "text": text,
        "voice_id": "hope",  # Using "Hope" voice
        "encoding": "mp3"  # Audio format (MP3)
    }
    
    response = requests.post(url, json=data, headers=headers)
    
    if response.status_code == 200:
        audio_data = response.json()
        audio_url = audio_data.get("audio_url")  # URL to the generated audio file
        return audio_url
    else:
        print("Error generating audio:", response.text)
        return None

# Route to handle the outbound call and return TwiML
@app.route('/outbound-call', methods=['POST'])
def initiate_outbound_call():
    # Extract the phone number from the request body
    data = request.json
    number = data.get('number')

    if not number:
        return jsonify({"error": "Phone number is required"}), 400

    try:
        # Create a call using Twilio
        call = twilio_client.calls.create(
            from_=TWILIO_PHONE_NUMBER,
            to=number,
            url=f"https://{request.host}/outbound-call-twiml"  # URL for the TwiML response
        )
        return jsonify({
            "success": True,
            "message": "Call initiated",
            "callSid": call.sid
        })
    except Exception as error:
        print(f"Error initiating outbound call: {error}")
        return jsonify({"success": False, "error": "Failed to initiate call"}), 500

# Route to handle the outbound call TwiML response
@app.route('/outbound-call-twiml', methods=['GET', 'POST'])
def outbound_call_twiml():
    # The text you want to convert to speech
    prompt = "Hello, this is Hope. How can I assist you today?"

    # Generate the audio URL using ElevenLabs
    audio_url = generate_elevenlabs_audio(prompt)
    
    if not audio_url:
        return "Error generating voice response", 500
    
    # Create TwiML response with <Play> to play the generated audio
    response = VoiceResponse()
    response.play(audio_url)  # Play the audio generated by ElevenLabs
    
    return str(response)

# Route for the index page (form to input phone number)
@app.route('/')
def index():
    return '''
        <h2>Initiate Outbound Call</h2>
        <form action="/outbound-call" method="post">
            <label for="phoneNumber">Enter Phone Number:</label>
            <input type="text" id="phoneNumber" name="number" required>
            <button type="submit">Call</button>
        </form>
    '''

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
